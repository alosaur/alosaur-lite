var c;(function(t){t.Get="GET",t.Post="POST",t.Put="PUT",t.Delete="DELETE",t.Path="PATCH",t.Options="OPTIONS"})(c||(c={}));var p;(function(t){t.Cookie="cookie",t.Context="context",t.Response="response",t.Request="request",t.Query="query",t.RouteParam="route-param",t.Body="body"})(p||(p={}));var m=class{constructor(e){this.request=e}};var d={};function i(){return d.routingControllersMetadataArgsStorage||(d.routingControllersMetadataArgsStorage=new h),d.routingControllersMetadataArgsStorage}var h=class{constructor(){this.controllers=[];this.actions=[];this.params=[]}};var l=(t,e)=>!e||t===e,b=t=>t.split("/").reduce((e,r,n)=>{if(/:[A-Za-z1-9]{1,}/.test(r)){let o=r.replace(":","");e.push({i:n,el:o})}return e},[]),F=t=>t.replace(/\/\:[^/]{1,}/gi,"/[^/]{1,}").replace(/\//g,"\\/"),y=(t,e,r)=>t.filter(n=>n.route.includes("/:")&&l(n.method,r)).find(n=>new RegExp("^"+F(n.route)+"$").test(e)),A=(t,e,r)=>t.find(n=>l(n.method,r)&&n.route===e),M=(t,e,r)=>t.filter(n=>n.regexpRoute&&l(n.method.toString(),r)).find(n=>{let o=new RegExp("^"+n.route);return o.test(e)&&n.regexpRoute.test(e.replace(o,""))});function P(t){return k(t).pathname}var f=new Map;function k(t){return f.has(t)||f.set(t,new URL(t)),f.get(t)}function O(t,e,r){let n=P(r),o={},a=A(t,n,e);if(a||(a=M(t,n,e)),!a&&(a=y(t,n,e),a)){let g=b(a.route),s=n.split("/");g.forEach(u=>{o[u.el]=s[u.i]})}return a?{controllerObject:a.controllerObject,actionObject:a.actionObject,target:a.target,action:a.action,actionMetadata:a.actionMetadata,params:a.params,routeParams:o}:null}async function j(t,e){if(e.params.length==0)return[];let r=[],n=e.params.sort((o,a)=>o.index-a.index);for(let o=0;o<n.length;o++){let a=n[o];switch(a.type){case"query":let g=w(t.request.url);if(g&&a.name){let s=g.get(a.name);r.push(s||void 0)}else r.push(void 0);break;case"cookie":case"body":break;case"request":r.push(t.request);break;case"response":r.push(t.response);break;case"context":r.push(t);break;case"route-param":e.routeParams&&a.name?r.push(e.routeParams[a.name]):r.push(void 0);break;default:r.push(void 0);break}}return r}function w(t){let e=t.split("?")[1];if(!!e)return new URLSearchParams(e)}var C=class extends Response{constructor(){super(...arguments);this.__isContentResult__=!0}};function x(t,e=200){let r=new Headers,n=t;switch(typeof t){case"object":case"boolean":case"number":r.set("content-type","application/json; charset=utf-8"),n=JSON.stringify(t);break;default:r.set("content-type","text/html; charset=UTF-8");break}return new C(n,{status:e,headers:r})}var U=class{constructor(e){this.settings=e;this._routes=[];this.classes=[];this.metadata=i(),_(this.metadata,this.classes,r=>this._routes.push(r))}async handleRequest(e){let r=new m(e),n=O(this._routes,e.method,e.url);if(n!==null){let o=await j(r,n),a=await n.target[n.action](...o);return a.__isContentResult__||a instanceof Response?a:x(a)}return x("Not found",404)}};function _(t,e=[],r){t.controllers.forEach(n=>{let o=t.actions.filter(s=>s.target===n.target),a=t.params.filter(s=>s.target===n.target);n.actions=o;let g=new n.object;e.push(g),o.forEach(s=>{s.controller=n;let u="";n.route&&(u+=n.route);let R=s.route instanceof RegExp?s.route:void 0;!R&&s.route&&(u+=s.route),u===""&&(u="/");let S={route:u,regexpRoute:R,target:g,actionObject:s.object,controllerObject:n.target,actionMetadata:s,action:s.method,method:s.type,params:a.filter(E=>E.method===s.method)};r(S)})})}function et(t){return function(e){i().controllers.push({type:"default",object:e,target:e,route:t})}}function rt(t){return function(e,r){i().actions.push({type:c.Get,object:e,target:e.constructor,method:r,route:t})}}function nt(t){return function(e,r){i().actions.push({type:c.Post,object:e,target:e.constructor,method:r,route:t})}}function at(t){return function(e,r){i().actions.push({type:c.Put,object:e,target:e.constructor,method:r,route:t})}}function ot(t){return function(e,r){i().actions.push({type:c.Path,object:e,target:e.constructor,method:r,route:t})}}function st(t){return function(e,r){i().actions.push({type:c.Delete,object:e,target:e.constructor,method:r,route:t})}}function it(){return function(t,e,r){i().params.push({type:p.Context,target:t.constructor,method:e,index:r})}}function ut(t){return function(e,r,n){i().params.push({type:p.RouteParam,target:e.constructor,method:r,index:n,name:t})}}function ct(t){return function(e,r,n){i().params.push({type:p.Query,target:e.constructor,method:r,index:n,name:t})}}export{U as App,x as Content,C as ContentResponse,et as Controller,it as Ctx,st as Delete,rt as Get,m as HttpContext,h as MetadataArgsStorage,ut as Param,p as ParamType,ot as Patch,nt as Post,at as Put,ct as QueryParam,c as RequestMethod,i as getMetadataArgsStorage,_ as registerControllers};
