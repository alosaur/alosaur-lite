var g;(function(t){t.Get="GET",t.Post="POST",t.Put="PUT",t.Delete="DELETE",t.Path="PATCH",t.Options="OPTIONS"})(g||(g={}));var p;(function(t){t.Cookie="cookie",t.Context="context",t.Response="response",t.Request="request",t.Query="query",t.RouteParam="route-param",t.Body="body"})(p||(p={}));var d=class{constructor(e){this.request=e}};var f={};function i(){return f.routingControllersMetadataArgsStorage||(f.routingControllersMetadataArgsStorage=new y),f.routingControllersMetadataArgsStorage}var y=class{constructor(){this.controllers=[];this.actions=[];this.params=[]}};var m=(t,e)=>!e||t===e,b=t=>t.split("/").reduce((e,r,n)=>{if(/:[A-Za-z1-9]{1,}/.test(r)){let s=r.replace(":","");e.push({i:n,el:s})}return e},[]),k=t=>t.replace(/\/\:[^/]{1,}/gi,"/[^/]{1,}").replace(/\//g,"\\/"),C=(t,e,r)=>t.filter(n=>n.route.includes("/:")&&m(n.method,r)).find(n=>new RegExp("^"+k(n.route)+"$").test(e)),A=(t,e,r)=>t.find(n=>m(n.method,r)&&n.route===e),P=(t,e,r)=>t.filter(n=>n.regexpRoute&&m(n.method.toString(),r)).find(n=>{let s=new RegExp("^"+n.route);return s.test(e)&&n.regexpRoute.test(e.replace(s,""))});function w(t){return R(t).pathname}var x=new Map;function R(t){return x.has(t)||x.set(t,new URL(t)),x.get(t)}function M(t,e,r){let n=w(r),s={},o=A(t,n,e);if(o||(o=P(t,n,e)),!o&&(o=C(t,n,e),o)){let u=b(o.route),a=n.split("/");u.forEach(c=>{s[c.el]=a[c.i]})}return o?{controllerObject:o.controllerObject,actionObject:o.actionObject,target:o.target,action:o.action,actionMetadata:o.actionMetadata,params:o.params,routeParams:s}:null}async function S(t,e){if(e.params.length==0)return[];let r=[],n=e.params.sort((s,o)=>s.index-o.index);for(let s=0;s<n.length;s++){let o=n[s];switch(o.type){case"query":let u=_(t.request.url);if(u&&o.name){let a=u.get(o.name);r.push(a||void 0)}else r.push(void 0);break;case"cookie":case"body":break;case"request":r.push(t.request);break;case"response":r.push(t.response);break;case"context":r.push(t);break;case"route-param":e.routeParams&&o.name?r.push(e.routeParams[o.name]):r.push(void 0);break;default:r.push(void 0);break}}return r}function _(t){let e=t.split("?")[1];if(!!e)return new URLSearchParams(e)}var j=class extends Response{constructor(){super(...arguments);this.__isContentResult__=!0}};function l(t,e=200){let r=new Headers,n=t;switch(typeof t){case"object":case"boolean":case"number":r.set("content-type","application/json; charset=utf-8"),n=JSON.stringify(t);break;default:r.set("content-type","text/html; charset=UTF-8");break}return new j(n,{status:e,headers:r})}async function Q(t,e,r=200){let n=O();return l(await n.getBody(t,e,n),r)}async function F(t,{root:e,index:r,baseRoute:n}){let o=R(t.url).pathname;if(n){let a=new RegExp(`^${n}`);if(a.test(o))o=o.replace(a,"");else return null}let u;try{o[0]==="/"&&(o=o.replace("/","")),(o[o.length-1]==="/"||o==="")&&(o+=r);let c=new URL(o,e).toString();if(u=await fetch(new Request(c,t)),u.status===404)return null}catch(a){return null}return u}function O(){return window.viewRenderConfig}var v=class{constructor(e){this.settings=e;this.classes=[];this.viewRenderConfig=void 0;this._routes=[];this.metadata=i(),V(this.metadata,this.classes,r=>this._routes.push(r))}async handleRequest(e){let r=new d(e);if(this._staticConfig){let s=await F(e,this._staticConfig);if(s)return s}let n=M(this._routes,e.method,e.url);if(n!==null){let s=await S(r,n),o=await n.target[n.action](...s);return o.__isContentResult__||o instanceof Response?o:l(o)}return l("Not found",404)}useStatic(e){e&&!this._staticConfig&&(this._staticConfig=e)}useViewRender(e){e&&!this.viewRenderConfig&&(this.viewRenderConfig=e,window.viewRenderConfig=e)}};function V(t,e=[],r){t.controllers.forEach(n=>{let s=t.actions.filter(a=>a.target===n.target),o=t.params.filter(a=>a.target===n.target);n.actions=s;let u=new n.object;e.push(u),s.forEach(a=>{a.controller=n;let c="";n.route&&(c+=n.route);let h=a.route instanceof RegExp?a.route:void 0;!h&&a.route&&(c+=a.route),c===""&&(c="/");let E={route:c,regexpRoute:h,target:u,actionObject:a.object,controllerObject:n.target,actionMetadata:a,action:a.method,method:a.type,params:o.filter(U=>U.method===a.method)};r(E)})})}function gt(t){return function(e){i().controllers.push({type:"default",object:e,target:e,route:t})}}function pt(t){return function(e,r){i().actions.push({type:g.Get,object:e,target:e.constructor,method:r,route:t})}}function lt(t){return function(e,r){i().actions.push({type:g.Post,object:e,target:e.constructor,method:r,route:t})}}function dt(t){return function(e,r){i().actions.push({type:g.Put,object:e,target:e.constructor,method:r,route:t})}}function ft(t){return function(e,r){i().actions.push({type:g.Path,object:e,target:e.constructor,method:r,route:t})}}function mt(t){return function(e,r){i().actions.push({type:g.Delete,object:e,target:e.constructor,method:r,route:t})}}function Rt(){return function(t,e,r){i().params.push({type:p.Context,target:t.constructor,method:e,index:r})}}function xt(t){return function(e,r,n){i().params.push({type:p.RouteParam,target:e.constructor,method:r,index:n,name:t})}}function ht(t){return function(e,r,n){i().params.push({type:p.Query,target:e.constructor,method:r,index:n,name:t})}}export{v as App,l as Content,j as ContentResponse,gt as Controller,Rt as Ctx,mt as Delete,pt as Get,d as HttpContext,y as MetadataArgsStorage,xt as Param,p as ParamType,ft as Patch,lt as Post,dt as Put,ht as QueryParam,g as RequestMethod,Q as View,i as getMetadataArgsStorage,O as getViewRenderConfig,V as registerControllers};
